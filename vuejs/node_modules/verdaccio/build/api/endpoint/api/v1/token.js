"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _lodash = _interopRequireDefault(require("lodash"));

var _constants = require("../../../../lib/constants");

var _utils = require("../../../../lib/utils");

var _authUtils = require("../../../../lib/auth-utils");

var _cryptoUtils = require("../../../../lib/crypto-utils");

var _logger = require("../../../../lib/logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function normalizeToken(token) {
  return _objectSpread(_objectSpread({}, token), {}, {
    created: new Date(token.created).toISOString()
  });
} // https://github.com/npm/npm-profile/blob/latest/lib/index.js


function _default(route, auth, storage, config) {
  route.get('/-/npm/v1/tokens', async function (req, res, next) {
    const {
      name
    } = req.remote_user;

    if (_lodash.default.isNil(name) === false) {
      try {
        const tokens = await storage.readTokens({
          user: name
        });
        const totalTokens = tokens.length;

        _logger.logger.debug({
          totalTokens
        }, 'token list retrieved: @{totalTokens}');

        res.status(_constants.HTTP_STATUS.OK);
        return next({
          objects: tokens.map(normalizeToken),
          urls: {
            next: '' // TODO: pagination?

          }
        });
      } catch (error) {
        _logger.logger.error({
          error: error.msg
        }, 'token list has failed: @{error}');

        return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.INTERNAL_ERROR, error.message));
      }
    }

    return next(_utils.ErrorCode.getUnauthorized());
  });
  route.post('/-/npm/v1/tokens', function (req, res, next) {
    const {
      password,
      readonly,
      cidr_whitelist
    } = req.body;
    const {
      name
    } = req.remote_user;

    if (!_lodash.default.isBoolean(readonly) || !_lodash.default.isArray(cidr_whitelist)) {
      return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.BAD_DATA, _constants.SUPPORT_ERRORS.PARAMETERS_NOT_VALID));
    }

    auth.authenticate(name, password, async (err, user) => {
      if (err) {
        const errorCode = err.message ? _constants.HTTP_STATUS.UNAUTHORIZED : _constants.HTTP_STATUS.INTERNAL_ERROR;
        return next(_utils.ErrorCode.getCode(errorCode, err.message));
      }

      req.remote_user = user;

      if (!_lodash.default.isFunction(storage.saveToken)) {
        return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.NOT_IMPLEMENTED, _constants.SUPPORT_ERRORS.STORAGE_NOT_IMPLEMENT));
      }

      try {
        const token = await (0, _authUtils.getApiToken)(auth, config, user, password);
        const key = (0, _cryptoUtils.stringToMD5)(token); // TODO: use a utility here

        const maskedToken = (0, _utils.mask)(token, 5);
        const created = new Date().getTime();
        /**
         * cidr_whitelist: is not being used, we pass it through
         * token: we do not store the real token (it is generated once and retrieved to the user), just a mask of it.
         */

        const saveToken = {
          user: name,
          token: maskedToken,
          key,
          cidr: cidr_whitelist,
          readonly,
          created
        };
        await storage.saveToken(saveToken);

        _logger.logger.debug({
          key,
          name
        }, 'token @{key} was created for user @{name}');

        return next(normalizeToken({
          token,
          user: name,
          key: saveToken.key,
          cidr: cidr_whitelist,
          readonly,
          created: saveToken.created
        }));
      } catch (error) {
        _logger.logger.error({
          error: error.msg
        }, 'token creation has failed: @{error}');

        return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.INTERNAL_ERROR, error.message));
      }
    });
  });
  route.delete('/-/npm/v1/tokens/token/:tokenKey', async (req, res, next) => {
    const {
      params: {
        tokenKey
      }
    } = req;
    const {
      name
    } = req.remote_user;

    if (_lodash.default.isNil(name) === false) {
      _logger.logger.debug({
        name
      }, '@{name} has requested remove a token');

      try {
        await storage.deleteToken(name, tokenKey);

        _logger.logger.info({
          tokenKey,
          name
        }, 'token id @{tokenKey} was revoked for user @{name}');

        return next({});
      } catch (error) {
        _logger.logger.error({
          error: error.msg
        }, 'token creation has failed: @{error}');

        return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.INTERNAL_ERROR, error.message));
      }
    }

    return next(_utils.ErrorCode.getUnauthorized());
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hcGkvZW5kcG9pbnQvYXBpL3YxL3Rva2VuLnRzIl0sIm5hbWVzIjpbIm5vcm1hbGl6ZVRva2VuIiwidG9rZW4iLCJjcmVhdGVkIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwicm91dGUiLCJhdXRoIiwic3RvcmFnZSIsImNvbmZpZyIsImdldCIsInJlcSIsInJlcyIsIm5leHQiLCJuYW1lIiwicmVtb3RlX3VzZXIiLCJfIiwiaXNOaWwiLCJ0b2tlbnMiLCJyZWFkVG9rZW5zIiwidXNlciIsInRvdGFsVG9rZW5zIiwibGVuZ3RoIiwibG9nZ2VyIiwiZGVidWciLCJzdGF0dXMiLCJIVFRQX1NUQVRVUyIsIk9LIiwib2JqZWN0cyIsIm1hcCIsInVybHMiLCJlcnJvciIsIm1zZyIsIkVycm9yQ29kZSIsImdldENvZGUiLCJJTlRFUk5BTF9FUlJPUiIsIm1lc3NhZ2UiLCJnZXRVbmF1dGhvcml6ZWQiLCJwb3N0IiwicGFzc3dvcmQiLCJyZWFkb25seSIsImNpZHJfd2hpdGVsaXN0IiwiYm9keSIsImlzQm9vbGVhbiIsImlzQXJyYXkiLCJCQURfREFUQSIsIlNVUFBPUlRfRVJST1JTIiwiUEFSQU1FVEVSU19OT1RfVkFMSUQiLCJhdXRoZW50aWNhdGUiLCJlcnIiLCJlcnJvckNvZGUiLCJVTkFVVEhPUklaRUQiLCJpc0Z1bmN0aW9uIiwic2F2ZVRva2VuIiwiTk9UX0lNUExFTUVOVEVEIiwiU1RPUkFHRV9OT1RfSU1QTEVNRU5UIiwia2V5IiwibWFza2VkVG9rZW4iLCJnZXRUaW1lIiwiY2lkciIsImRlbGV0ZSIsInBhcmFtcyIsInRva2VuS2V5IiwiZGVsZXRlVG9rZW4iLCJpbmZvIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7QUFRQSxTQUFTQSxjQUFULENBQXdCQyxLQUF4QixFQUFzRDtBQUNwRCx5Q0FDS0EsS0FETDtBQUVFQyxJQUFBQSxPQUFPLEVBQUUs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Q0osS0FBSyxDQUFDSyxPQUFwRCxDQUFELENBQVg7QUFDRDtBQUNGOztBQUNELFdBQU92QixJQUFJLENBQUNvQixpQkFBVUksZUFBVixFQUFELENBQVg7QUFDRCxHQXBCSDtBQXNCRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBSZXNwb25zZSwgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBDb25maWcsIFJlbW90ZVVzZXIsIFRva2VuIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5pbXBvcnQgeyBIVFRQX1NUQVRVUywgU1VQUE9SVF9FUlJPUlMgfSBmcm9tICcuLi8uLi8uLi8uLi9saWIvY29uc3RhbnRzJztcbmltcG9ydCB7IEVycm9yQ29kZSwgbWFzayB9IGZyb20gJy4uLy4uLy4uLy4uL2xpYi91dGlscyc7XG5pbXBvcnQgeyBnZXRBcGlUb2tlbiB9IGZyb20gJy4uLy4uLy4uLy4uL2xpYi9hdXRoLXV0aWxzJztcbmltcG9ydCB7IHN0cmluZ1RvTUQ1IH0gZnJvbSAnLi4vLi4vLi4vLi4vbGliL2NyeXB0by11dGlscyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi8uLi8uLi8uLi9saWIvbG9nZ2VyJztcblxuaW1wb3J0IHsgJE5leHRGdW5jdGlvblZlciwgJFJlcXVlc3RFeHRlbmQsIElBdXRoLCBJU3RvcmFnZUhhbmRsZXIgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi90eXBlcyc7XG5cbmV4cG9ydCB0eXBlIE5vcm1hbGl6ZVRva2VuID0gVG9rZW4gJiB7XG4gIGNyZWF0ZWQ6IHN0cmluZztcbn07XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZVRva2VuKHRva2VuOiBUb2tlbik6IE5vcm1hbGl6ZVRva2VuIHtcbiAgcmV0dXJuIHtcbiAgICAuLi50b2tlbixcbiAgICBjcmVhdGVkOiBuZXcgRGF0ZSh0b2tlbi5jcmVhdGVkKS50b0lTT1N0cmluZygpXG4gIH07XG59XG5cbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9ucG0vbnBtLXByb2ZpbGUvYmxvYi9sYXRlc3QvbGliL2luZGV4LmpzXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAoXG4gIHJvdXRlOiBSb3V0ZXIsXG4gIGF1dGg6IElBdXRoLFxuICBzdG9yYWdlOiBJU3RvcmFnZUhhbmRsZXIsXG4gIGNvbmZpZzogQ29uZmlnXG4pOiB2b2lkIHtcbiAgcm91dGUuZ2V0KFxuICAgICcvLS9ucG0vdjEvdG9rZW5zJyxcbiAgICBhc3luYyBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiBSZXNwb25zZSwgbmV4dDogJE5leHRGdW5jdGlvblZlcikge1xuICAgICAgY29uc3QgeyBuYW1lIH0gPSByZXEucmVtb3RlX3VzZXI7XG5cbiAgICAgIGlmIChfLmlzTmlsKG5hbWUpID09PSBmYWxzZSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHRva2VucyA9IGF3YWl0IHN0b3JhZ2UucmVhZFRva2Vucyh7IHVzZXI6IG5hbWUgfSk7XG4gICAgICAgICAgY29uc3QgdG90YWxUb2tlbnMgPSB0b2tlbnMubGVuZ3RoO1xuICAgICAgICAgIGxvZ2dlci5kZWJ1Zyh7IHRvdGFsVG9rZW5zIH0sICd0b2tlbiBsaXN0IHJldHJpZXZlZDogQHt0b3RhbFRva2Vuc30nKTtcblxuICAgICAgICAgIHJlcy5zdGF0dXMoSFRUUF9TVEFUVVMuT0spO1xuICAgICAgICAgIHJldHVybiBuZXh0KHtcbiAgICAgICAgICAgIG9iamVjdHM6IHRva2Vucy5tYXAobm9ybWFsaXplVG9rZW4pLFxuICAgICAgICAgICAgdXJsczoge1xuICAgICAgICAgICAgICBuZXh0OiAnJyAvLyBUT0RPOiBwYWdpbmF0aW9uP1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yOiBlcnJvci5tc2cgfSwgJ3Rva2VuIGxpc3QgaGFzIGZhaWxlZDogQHtlcnJvcn0nKTtcbiAgICAgICAgICByZXR1cm4gbmV4dChFcnJvckNvZGUuZ2V0Q29kZShIVFRQX1NUQVRVUy5JTlRFUk5BTF9FUlJPUiwgZXJyb3IubWVzc2FnZSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gbmV4dChFcnJvckNvZGUuZ2V0VW5hdXRob3JpemVkKCkpO1xuICAgIH1cbiAgKTtcblxuICByb3V0ZS5wb3N0KFxuICAgICcvLS9ucG0vdjEvdG9rZW5zJyxcbiAgICBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiBSZXNwb25zZSwgbmV4dDogJE5leHRGdW5jdGlvblZlcikge1xuICAgICAgY29uc3QgeyBwYXNzd29yZCwgcmVhZG9ubHksIGNpZHJfd2hpdGVsaXN0IH0gPSByZXEuYm9keTtcbiAgICAgIGNvbnN0IHsgbmFtZSB9ID0gcmVxLnJlbW90ZV91c2VyO1xuXG4gICAgICBpZiAoIV8uaXNCb29sZWFuKHJlYWRvbmx5KSB8fCAhXy5pc0FycmF5KGNpZHJfd2hpdGVsaXN0KSkge1xuICAgICAgICByZXR1cm4gbmV4dChFcnJvckNvZGUuZ2V0Q29kZShIVFRQX1NUQVRVUy5CQURfREFUQSwgU1VQUE9SVF9FUlJPUlMuUEFSQU1FVEVSU19OT1RfVkFMSUQpKTtcbiAgICAgIH1cblxuICAgICAgYXV0aC5hdXRoZW50aWNhdGUobmFtZSwgcGFzc3dvcmQsIGFzeW5jIChlcnIsIHVzZXI6IFJlbW90ZVVzZXIpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGNvbnN0IGVycm9yQ29kZSA9IGVyci5tZXNzYWdlID8gSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVEIDogSFRUUF9TVEFUVVMuSU5URVJOQUxfRVJST1I7XG4gICAgICAgICAgcmV0dXJuIG5leHQoRXJyb3JDb2RlLmdldENvZGUoZXJyb3JDb2RlLCBlcnIubWVzc2FnZSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVxLnJlbW90ZV91c2VyID0gdXNlcjtcblxuICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihzdG9yYWdlLnNhdmVUb2tlbikpIHtcbiAgICAgICAgICByZXR1cm4gbmV4dChcbiAgICAgICAgICAgIEVycm9yQ29kZS5nZXRDb2RlKEhUVFBfU1RBVFVTLk5PVF9JTVBMRU1FTlRFRCwgU1VQUE9SVF9FUlJPUlMuU1RPUkFHRV9OT1RfSU1QTEVNRU5UKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHRva2VuID0gYXdhaXQgZ2V0QXBpVG9rZW4oYXV0aCwgY29uZmlnLCB1c2VyLCBwYXNzd29yZCk7XG4gICAgICAgICAgY29uc3Qga2V5ID0gc3RyaW5nVG9NRDUodG9rZW4pO1xuICAgICAgICAgIC8vIFRPRE86IHVzZSBhIHV0aWxpdHkgaGVyZVxuICAgICAgICAgIGNvbnN0IG1hc2tlZFRva2VuID0gbWFzayh0b2tlbiwgNSk7XG4gICAgICAgICAgY29uc3QgY3JlYXRlZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG4gICAgICAgICAgLyoqXG4gICAgICAgICAgICogY2lkcl93aGl0ZWxpc3Q6IGlzIG5vdCBiZWluZyB1c2VkLCB3ZSBwYXNzIGl0IHRocm91Z2hcbiAgICAgICAgICAgKiB0b2tlbjogd2UgZG8gbm90IHN0b3JlIHRoZSByZWFsIHRva2VuIChpdCBpcyBnZW5lcmF0ZWQgb25jZSBhbmQgcmV0cmlldmVkIHRvIHRoZSB1c2VyKSwganVzdCBhIG1hc2sgb2YgaXQuXG4gICAgICAgICAgICovXG4gICAgICAgICAgY29uc3Qgc2F2ZVRva2VuOiBUb2tlbiA9IHtcbiAgICAgICAgICAgIHVzZXI6IG5hbWUsXG4gICAgICAgICAgICB0b2tlbjogbWFza2VkVG9rZW4sXG4gICAgICAgICAgICBrZXksXG4gICAgICAgICAgICBjaWRyOiBjaWRyX3doaXRlbGlzdCxcbiAgICAgICAgICAgIHJlYWRvbmx5LFxuICAgICAgICAgICAgY3JlYXRlZFxuICAgICAgICAgIH07XG5cbiAgICAgICAgICBhd2FpdCBzdG9yYWdlLnNhdmVUb2tlbihzYXZlVG9rZW4pO1xuICAgICAgICAgIGxvZ2dlci5kZWJ1Zyh7IGtleSwgbmFtZSB9LCAndG9rZW4gQHtrZXl9IHdhcyBjcmVhdGVkIGZvciB1c2VyIEB7bmFtZX0nKTtcbiAgICAgICAgICByZXR1cm4gbmV4dChcbiAgICAgICAgICAgIG5vcm1hbGl6ZVRva2VuKHtcbiAgICAgICAgICAgICAgdG9rZW4sXG4gICAgICAgICAgICAgIHVzZXI6IG5hbWUsXG4gICAgICAgICAgICAgIGtleTogc2F2ZVRva2VuLmtleSxcbiAgICAgICAgICAgICAgY2lkcjogY2lkcl93aGl0ZWxpc3QsXG4gICAgICAgICAgICAgIHJlYWRvbmx5LFxuICAgICAgICAgICAgICBjcmVhdGVkOiBzYXZlVG9rZW4uY3JlYXRlZFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yOiBlcnJvci5tc2cgfSwgJ3Rva2VuIGNyZWF0aW9uIGhhcyBmYWlsZWQ6IEB7ZXJyb3J9Jyk7XG4gICAgICAgICAgcmV0dXJuIG5leHQoRXJyb3JDb2RlLmdldENvZGUoSFRUUF9TVEFUVVMuSU5URVJOQUxfRVJST1IsIGVycm9yLm1lc3NhZ2UpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICApO1xuXG4gIHJvdXRlLmRlbGV0ZShcbiAgICAnLy0vbnBtL3YxL3Rva2Vucy90b2tlbi86dG9rZW5LZXknLFxuICAgIGFzeW5jIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6IFJlc3BvbnNlLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKSA9PiB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHBhcmFtczogeyB0b2tlbktleSB9XG4gICAgICB9ID0gcmVxO1xuICAgICAgY29uc3QgeyBuYW1lIH0gPSByZXEucmVtb3RlX3VzZXI7XG5cbiAgICAgIGlmIChfLmlzTmlsKG5hbWUpID09PSBmYWxzZSkge1xuICAgICAgICBsb2dnZXIuZGVidWcoeyBuYW1lIH0sICdAe25hbWV9IGhhcyByZXF1ZXN0ZWQgcmVtb3ZlIGEgdG9rZW4nKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBzdG9yYWdlLmRlbGV0ZVRva2VuKG5hbWUsIHRva2VuS2V5KTtcbiAgICAgICAgICBsb2dnZXIuaW5mbyh7IHRva2VuS2V5LCBuYW1lIH0sICd0b2tlbiBpZCBAe3Rva2VuS2V5fSB3YXMgcmV2b2tlZCBmb3IgdXNlciBAe25hbWV9Jyk7XG4gICAgICAgICAgcmV0dXJuIG5leHQoe30pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yOiBlcnJvci5tc2cgfSwgJ3Rva2VuIGNyZWF0aW9uIGhhcyBmYWlsZWQ6IEB7ZXJyb3J9Jyk7XG4gICAgICAgICAgcmV0dXJuIG5leHQoRXJyb3JDb2RlLmdldENvZGUoSFRUUF9TVEFUVVMuSU5URVJOQUxfRVJST1IsIGVycm9yLm1lc3NhZ2UpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIG5leHQoRXJyb3JDb2RlLmdldFVuYXV0aG9yaXplZCgpKTtcbiAgICB9XG4gICk7XG59XG4iXX0=