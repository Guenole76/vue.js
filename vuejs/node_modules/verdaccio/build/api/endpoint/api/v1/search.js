"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _semver = _interopRequireDefault(require("semver"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function compileTextSearch(textSearch) {
  const personMatch = (person, search) => {
    if (typeof person === 'string') {
      return person.includes(search);
    }

    if (typeof person === 'object') {
      for (const field of Object.values(person)) {
        if (typeof field === 'string' && field.includes(search)) {
          return true;
        }
      }
    }

    return false;
  };

  const matcher = function (q) {
    const match = q.match(/author:(.*)/);

    if (match !== null) {
      return pkg => personMatch(pkg.author, match[1]);
    } // TODO: maintainer, keywords, not/is unstable insecure, boost-exact
    // TODO implement some scoring system for freetext


    return pkg => {
      return ['name', 'displayName', 'description'].map(k => pkg[k]).filter(x => x !== undefined).some(txt => txt.includes(q));
    };
  };

  const textMatchers = (textSearch || '').split(' ').map(matcher);
  return pkg => textMatchers.every(m => m(pkg));
}

function _default(route, auth, storage) {
  route.get('/-/v1/search', (req, res) => {
    // TODO: implement proper result scoring weighted by quality, popularity and maintenance query parameters
    let [text, size, from
    /* , quality, popularity, maintenance */
    ] = ['text', 'size', 'from'
    /* , 'quality', 'popularity', 'maintenance' */
    ].map(k => req.query[k]);
    size = parseInt(size) || 20;
    from = parseInt(from) || 0;
    const isInteresting = compileTextSearch(text);
    const resultStream = storage.search(0, {
      req: {
        query: {
          local: true
        }
      }
    });
    const resultBuf = [];
    let completed = false;

    const sendResponse = () => {
      completed = true;
      resultStream.destroy();
      const final = resultBuf.slice(from, size).map(pkg => {
        return {
          package: pkg,
          flags: {
            unstable: Object.keys(pkg.versions).some(v => _semver.default.satisfies(v, '^1.0.0')) ? undefined : true
          },
          score: {
            final: 1,
            detail: {
              quality: 1,
              popularity: 1,
              maintenance: 0
            }
          },
          searchScore: 100000
        };
      });
      const response = {
        objects: final,
        total: final.length,
        time: new Date().toUTCString()
      };
      res.status(200).json(response);
    };

    resultStream.on('data', pkg => {
      if (!isInteresting(pkg)) {
        return;
      }

      resultBuf.push(pkg);

      if (!completed && resultBuf.length >= size + from) {
        sendResponse();
      }
    });
    resultStream.on('end', () => {
      if (!completed) {
        sendResponse();
      }
    });
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9hcGkvZW5kcG9pbnQvYXBpL3YxL3NlYXJjaC50cyJdLCJuYW1lcyI6WyJjb21waWxlVGV4dFNlYXJjaCIsInRleHRTZWFyY2giLCJwZXJzb25NYXRjaCIsInBlcnNvbiIsInNlYXJjaCIsImluY2x1ZGVzIiwiZmllbGQiLCJPYmplY3QiLCJ2YWx1ZXMiLCJtYXRjaGVyIiwicSIsIm1hdGNoIiwicGtnIiwiYXV0aG9yIiwibWFwIiwiayIsImZpbHRlciIsIngiLCJ1bmRlZmluZWQiLCJzb21lIiwidHh0IiwidGV4dE1hdGNoZXJzIiwic3BsaXQiLCJldmVyeSIsIm0iLCJyb3V0ZSIsImF1dGgiLCJzdG9yYWdlIiwiZ2V0IiwicmVxIiwicmVzIiwidGV4dCIsInNpemUiLCJmcm9tIiwicXVlcnkiLCJwYXJzZUludCIsImlzSW50ZXJlc3RpbmciLCJyZXN1bHRTdHJlYW0iLCJsb2NhbCIsInJlc3VsdEJ1ZiIsImNvbXBsZXRlZCIsInNlbmRSZXNwb25zZSIsImRlc3Ryb3kiLCJmaW5hbCIsInNsaWNlIiwicGFja2FnZSIsImZsYWdzIiwidW5zdGFibGUiLCJrZXlzIiwidmVyc2lvbnMiLCJ2Iiwic2VtdmVyIiwic2F0aXNmaWVzIiwic2NvcmUiLCJkZXRhaWwiLCJxdWFsaXR5IiwicG9wdWxhcml0eSIsIm1haW50ZW5hbmNlIiwic2VhcmNoU2NvcmUiLCJyZXNwb25zZSIsIm9iamVjdHMiLCJ0b3RhbCIsImxlbmd0aCIsInRpbWUiLCJEYXRlIiwidG9VVENTdHJpbmciLCJzdGF0dXMiLCJqc29uIiwib24iLCJwdXNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7QUFHQSxTQUFTQSxpQkFBVCxDQUEyQkMsVUFBM0IsRUFBMEU7QUFDeEUsUUFBTUMsV0FBVyxHQUFHLENBQUNDLE1BQUQsRUFBU0MsTUFBVCxLQUFvQjtBQUN0QyxRQUFJLE9BQU9ELE1BQVAsS0FBa0IsUUFBdEIsRUFBZ0M7QUFDOUIsYUFBT0EsTUFBTSxD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UUFBQUEsWUFBWTtBQUNiO0FBQ0YsS0FSRDtBQVNBSixJQUFBQSxZQUFZLENBQUMrQixFQUFiLENBQWdCLEtBQWhCLEVBQXVCLE1BQU07QUFDM0IsVUFBSSxDQUFDNUIsU0FBTCxFQUFnQjtBQUNkQyxRQUFBQSxZQUFZO0FBQ2I7QUFDRixLQUpEO0FBS0QsR0EvREQ7QUFnRUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgeyBQYWNrYWdlIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5cbmZ1bmN0aW9uIGNvbXBpbGVUZXh0U2VhcmNoKHRleHRTZWFyY2g6IHN0cmluZyk6IChwa2c6IFBhY2thZ2UpID0+IGJvb2xlYW4ge1xuICBjb25zdCBwZXJzb25NYXRjaCA9IChwZXJzb24sIHNlYXJjaCkgPT4ge1xuICAgIGlmICh0eXBlb2YgcGVyc29uID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHBlcnNvbi5pbmNsdWRlcyhzZWFyY2gpO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgcGVyc29uID09PSAnb2JqZWN0Jykge1xuICAgICAgZm9yIChjb25zdCBmaWVsZCBvZiBPYmplY3QudmFsdWVzKHBlcnNvbikpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBmaWVsZCA9PT0gJ3N0cmluZycgJiYgZmllbGQuaW5jbHVkZXMoc2VhcmNoKSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9O1xuICBjb25zdCBtYXRjaGVyID0gZnVuY3Rpb24gKHEpIHtcbiAgICBjb25zdCBtYXRjaCA9IHEubWF0Y2goL2F1dGhvcjooLiopLyk7XG4gICAgaWYgKG1hdGNoICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4gKHBrZykgPT4gcGVyc29uTWF0Y2gocGtnLmF1dGhvciwgbWF0Y2hbMV0pO1xuICAgIH1cblxuICAgIC8vIFRPRE86IG1haW50YWluZXIsIGtleXdvcmRzLCBub3QvaXMgdW5zdGFibGUgaW5zZWN1cmUsIGJvb3N0LWV4YWN0XG4gICAgLy8gVE9ETyBpbXBsZW1lbnQgc29tZSBzY29yaW5nIHN5c3RlbSBmb3IgZnJlZXRleHRcbiAgICByZXR1cm4gKHBrZykgPT4ge1xuICAgICAgcmV0dXJuIFsnbmFtZScsICdkaXNwbGF5TmFtZScsICdkZXNjcmlwdGlvbiddXG4gICAgICAgIC5tYXAoKGspID0+IHBrZ1trXSlcbiAgICAgICAgLmZpbHRlcigoeCkgPT4geCAhPT0gdW5kZWZpbmVkKVxuICAgICAgICAuc29tZSgodHh0KSA9PiB0eHQuaW5jbHVkZXMocSkpO1xuICAgIH07XG4gIH07XG5cbiAgY29uc3QgdGV4dE1hdGNoZXJzID0gKHRleHRTZWFyY2ggfHwgJycpLnNwbGl0KCcgJykubWFwKG1hdGNoZXIpO1xuICByZXR1cm4gKHBrZykgPT4gdGV4dE1hdGNoZXJzLmV2ZXJ5KChtKSA9PiBtKHBrZykpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAocm91dGUsIGF1dGgsIHN0b3JhZ2UpOiB2b2lkIHtcbiAgcm91dGUuZ2V0KCcvLS92MS9zZWFyY2gnLCAocmVxLCByZXMpID0+IHtcbiAgICAvLyBUT0RPOiBpbXBsZW1lbnQgcHJvcGVyIHJlc3VsdCBzY29yaW5nIHdlaWdodGVkIGJ5IHF1YWxpdHksIHBvcHVsYXJpdHkgYW5kIG1haW50ZW5hbmNlIHF1ZXJ5IHBhcmFtZXRlcnNcbiAgICBsZXQgW3RleHQsIHNpemUsIGZyb20gLyogLCBxdWFsaXR5LCBwb3B1bGFyaXR5LCBtYWludGVuYW5jZSAqL10gPSBbXG4gICAgICAndGV4dCcsXG4gICAgICAnc2l6ZScsXG4gICAgICAnZnJvbScgLyogLCAncXVhbGl0eScsICdwb3B1bGFyaXR5JywgJ21haW50ZW5hbmNlJyAqL1xuICAgIF0ubWFwKChrKSA9PiByZXEucXVlcnlba10pO1xuXG4gICAgc2l6ZSA9IHBhcnNlSW50KHNpemUpIHx8IDIwO1xuICAgIGZyb20gPSBwYXJzZUludChmcm9tKSB8fCAwO1xuXG4gICAgY29uc3QgaXNJbnRlcmVzdGluZyA9IGNvbXBpbGVUZXh0U2VhcmNoKHRleHQpO1xuXG4gICAgY29uc3QgcmVzdWx0U3RyZWFtID0gc3RvcmFnZS5zZWFyY2goMCwgeyByZXE6IHsgcXVlcnk6IHsgbG9jYWw6IHRydWUgfSB9IH0pO1xuICAgIGNvbnN0IHJlc3VsdEJ1ZiA9IFtdIGFzIGFueTtcbiAgICBsZXQgY29tcGxldGVkID0gZmFsc2U7XG5cbiAgICBjb25zdCBzZW5kUmVzcG9uc2UgPSAoKTogdm9pZCA9PiB7XG4gICAgICBjb21wbGV0ZWQgPSB0cnVlO1xuICAgICAgcmVzdWx0U3RyZWFtLmRlc3Ryb3koKTtcblxuICAgICAgY29uc3QgZmluYWwgPSByZXN1bHRCdWYuc2xpY2UoZnJvbSwgc2l6ZSkubWFwKChwa2cpID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBwYWNrYWdlOiBwa2csXG4gICAgICAgICAgZmxhZ3M6IHtcbiAgICAgICAgICAgIHVuc3RhYmxlOiBPYmplY3Qua2V5cyhwa2cudmVyc2lvbnMpLnNvbWUoKHYpID0+IHNlbXZlci5zYXRpc2ZpZXModiwgJ14xLjAuMCcpKVxuICAgICAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgICAgICA6IHRydWVcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNjb3JlOiB7XG4gICAgICAgICAgICBmaW5hbDogMSxcbiAgICAgICAgICAgIGRldGFpbDoge1xuICAgICAgICAgICAgICBxdWFsaXR5OiAxLFxuICAgICAgICAgICAgICBwb3B1bGFyaXR5OiAxLFxuICAgICAgICAgICAgICBtYWludGVuYW5jZTogMFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2VhcmNoU2NvcmU6IDEwMDAwMFxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IHtcbiAgICAgICAgb2JqZWN0czogZmluYWwsXG4gICAgICAgIHRvdGFsOiBmaW5hbC5sZW5ndGgsXG4gICAgICAgIHRpbWU6IG5ldyBEYXRlKCkudG9VVENTdHJpbmcoKVxuICAgICAgfTtcblxuICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24ocmVzcG9uc2UpO1xuICAgIH07XG5cbiAgICByZXN1bHRTdHJlYW0ub24oJ2RhdGEnLCAocGtnKSA9PiB7XG4gICAgICBpZiAoIWlzSW50ZXJlc3RpbmcocGtnKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICByZXN1bHRCdWYucHVzaChwa2cpO1xuICAgICAgaWYgKCFjb21wbGV0ZWQgJiYgcmVzdWx0QnVmLmxlbmd0aCA+PSBzaXplICsgZnJvbSkge1xuICAgICAgICBzZW5kUmVzcG9uc2UoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXN1bHRTdHJlYW0ub24oJ2VuZCcsICgpID0+IHtcbiAgICAgIGlmICghY29tcGxldGVkKSB7XG4gICAgICAgIHNlbmRSZXNwb25zZSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cbiJdfQ==