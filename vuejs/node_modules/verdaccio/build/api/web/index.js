"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.loadTheme = loadTheme;
exports.validatePrimaryColor = validatePrimaryColor;
exports.default = _default;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _express = _interopRequireDefault(require("express"));

var _utils = require("../../lib/utils");

var _search = _interopRequireDefault(require("../../lib/search"));

var _constants = require("../../lib/constants");

var _pluginLoader = _interopRequireDefault(require("../../lib/plugin-loader"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @prettier
 */
const {
  setSecurityWebHeaders
} = require('../middleware');

const pkgJSON = require('../../../package.json');

const DEFAULT_LANGUAGE = 'es-US';

function loadTheme(config) {
  if (_lodash.default.isNil(config.theme) === false) {
    return _lodash.default.head((0, _pluginLoader.default)(config, config.theme, {}, function (plugin) {
      return _lodash.default.isString(plugin);
    }, 'verdaccio-theme'));
  }
}

function validatePrimaryColor(primaryColor) {
  const isHex = /^#+([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/i.test(primaryColor);

  if (!isHex) {
    return '';
  }

  return primaryColor;
}

const sendFileCallback = next => err => {
  if (!err) {
    return;
  }

  if (err.status === _constants.HTTP_STATUS.NOT_FOUND) {
    next();
  } else {
    next(err);
  }
};

function _default(config, auth, storage) {
  _search.default.configureStorage(storage);
  /* eslint new-cap:off */


  const router = _express.default.Router();

  router.use(auth.webUIJWTmiddleware());
  router.use(setSecurityWebHeaders);

  const themePath = loadTheme(config) || require('@verdaccio/ui-theme')();

  const indexTemplate = _path.default.join(themePath, 'index.html');

  const template = _fs.default.readFileSync(indexTemplate).toString(); // Logo


  let logoURI = _lodash.default.get(config, 'web.logo') ? config.web.logo : '';

  if (logoURI && !(0, _utils.isHTTPProtocol)(logoURI)) {
    // URI related to a local file
    // Note: `path.join` will break on Windows, because it transforms `/` to `\`
    // Use POSIX version `path.posix.join` instead.
    logoURI = _path.default.posix.join('/-/static/', _path.default.basename(logoURI));
    router.get(logoURI, function (req, res, next) {
      res.sendFile(_path.default.resolve(config.web.logo), sendFileCallback(next));
    });
  } // Static


  router.get('/-/static/*', function (req, res, next) {
    const filename = req.params[0];
    const file = `${themePath}/${filename}`;
    res.sendFile(file, sendFileCallback(next));
  });

  function renderHTML(req, res) {
    var _config$i18n$web, _config$i18n, _config$web$darkMode, _config$web, _config$web2;

    const protocol = (0, _utils.getWebProtocol)(req.get(_constants.HEADERS.FORWARDED_PROTO), req.protocol);
    const host = req.get('host');
    const {
      url_prefix
    } = config;
    const uri = `${protocol}://${host}`;
    const base = (0, _utils.combineBaseUrl)(protocol, host, url_prefix);
    const language = (_config$i18n$web = config === null || config === void 0 ? void 0 : (_config$i18n = config.i18n) === null || _config$i18n === void 0 ? void 0 : _config$i18n.web) !== null && _config$i18n$web !== void 0 ? _config$i18n$web : DEFAULT_LANGUAGE;
    const darkMode = (_config$web$darkMode = config === null || config === void 0 ? void 0 : (_config$web = config.web) === null || _config$web === void 0 ? void 0 : _config$web.darkMode) !== null && _config$web$darkMode !== void 0 ? _config$web$darkMode : false;
    const primaryColor = validatePrimaryColor(config === null || config === void 0 ? void 0 : (_config$web2 = config.web) === null || _config$web2 === void 0 ? void 0 : _config$web2.primary_color);
    const title = _lodash.default.get(config, 'web.title') ? config.web.title : _constants.WEB_TITLE;
    const scope = _lodash.default.get(config, 'web.scope') ? config.web.scope : '';
    const options = {
      uri,
      darkMode,
      protocol,
      host,
      url_prefix,
      base,
      primaryColor,
      title,
      scope,
      language
    };
    const webPage = template.replace(/ToReplaceByVerdaccioUI/g, JSON.stringify(options)).replace(/ToReplaceByVerdaccio/g, base).replace(/ToReplaceByPrefix/g, url_prefix).replace(/ToReplaceByVersion/g, pkgJSON.version).replace(/ToReplaceByTitle/g, title).replace(/ToReplaceByLogo/g, logoURI).replace(/ToReplaceByPrimaryColor/g, primaryColor).replace(/ToReplaceByScope/g, scope);
    res.setHeader('Content-Type', _constants.HEADERS.TEXT_HTML);
    res.send(webPage);
  }

  router.get('/-/web/:section/*', function (req, res) {
    renderHTML(req, res);
  });
  router.get('/', function (req, res) {
    renderHTML(req, res);
  });
  return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvd2ViL2luZGV4LnRzIl0sIm5hbWVzIjpbInNldFNlY3VyaXR5V2ViSGVhZGVycyIsInJlcXVpcmUiLCJwa2dKU09OIiwiREVGQVVMVF9MQU5HVUFHRSIsImxvYWRUaGVtZSIsImNvbmZpZyIsIl8iLCJpc05pbCIsInRoZW1lIiwiaGVhZCIsInBsdWdpbiIsImlzU3RyaW5nIiwidmFsaWRhdGVQcmltYXJ5Q29sb3IiLCJwcmltYXJ5Q29sb3IiLCJpc0hleCIsInRlc3QiLCJzZW5kRmlsZUNhbGxiYWNrIiwibmV4dCIsImVyciIsInN0YXR1cyIsIkhUVFBfU1RBVFVTIiwiTk9UX0ZPVU5EIiwiYXV0aCIsInN0b3JhZ2UiLCJTZWFyY2giLCJjb25maWd1cmVTdG9yYWdlIiwicm91dGVyIiwiZXhwcmVzcyIsIlJvdXRlciIsInVzZSIsIndlYlVJSldUbWlkZGxld2FyZSIsInRoZW1lUGF0aCIsImluZGV4VGVtcGxhdGUiLCJwYXRoIiwiam9pbiIsInRlbXBsYXRlIiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsImxvZ29VUkkiLCJnZXQiLCJ3ZWIiLCJsb2dvIiwicG9zaXgiLCJiYXNlbmFtZSIsInJlcSIsInJlcyIsInNlbmRGaWxlIiwicmVzb2x2ZSIsImZpbGVuYW1lIiwicGFyYW1zIiwiZmlsZSIsInJlbmRlckhUTUwiLCJwcm90b2NvbCIsIkhFQURFUlMiLCJGT1JXQVJERURfUFJPVE8iLCJob3N0IiwidXJsX3ByZWZpeCIsInVyaSIsImJhc2UiLCJsYW5ndWFnZSIsImkxOG4iLCJkYXJrTW9kZSIsInByaW1hcnlfY29sb3IiLCJ0aXRsZSIsIldFQl9USVRMRSIsInNjb3BlIiwib3B0aW9ucyIsIndlYlBhZ2UiLCJyZXBsYWNlIiwiSlNPTiIsInN0cmluZ2lmeSIsInZlcnNpb24iLCJzZXRIZWFkZXIiLCJURVhUX0hUTUwiLCJzZW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFJQTs7QUFFQTs7QUFDQTs7QUFD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RDs7QUFFRDFDLEVBQUFBLE1BQU0sQ0FBQ2MsR0FBUCxDQUFXLG1CQUFYLEVBQWdDLFVBQVVLLEdBQVYsRUFBZUMsR0FBZixFQUFvQjtBQUNsRE0sSUFBQUEsVUFBVSxDQUFDUCxHQUFELEVBQU1DLEdBQU4sQ0FBVjtBQUNELEdBRkQ7QUFJQXBCLEVBQUFBLE1BQU0sQ0FBQ2MsR0FBUCxDQUFXLEdBQVgsRUFBZ0IsVUFBVUssR0FBVixFQUFlQyxHQUFmLEVBQW9CO0FBQ2xDTSxJQUFBQSxVQUFVLENBQUNQLEdBQUQsRUFBTUMsR0FBTixDQUFWO0FBQ0QsR0FGRDtBQUlBLFNBQU9wQixNQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBwcmV0dGllclxuICovXG5cbmltcG9ydCBmcyBmcm9tICdmcyc7XG5cbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuXG5pbXBvcnQgeyBjb21iaW5lQmFzZVVybCwgZ2V0V2ViUHJvdG9jb2wsIGlzSFRUUFByb3RvY29sIH0gZnJvbSAnLi4vLi4vbGliL3V0aWxzJztcbmltcG9ydCBTZWFyY2ggZnJvbSAnLi4vLi4vbGliL3NlYXJjaCc7XG5pbXBvcnQgeyBIRUFERVJTLCBIVFRQX1NUQVRVUywgV0VCX1RJVExFIH0gZnJvbSAnLi4vLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQgbG9hZFBsdWdpbiBmcm9tICcuLi8uLi9saWIvcGx1Z2luLWxvYWRlcic7XG5cbmNvbnN0IHsgc2V0U2VjdXJpdHlXZWJIZWFkZXJzIH0gPSByZXF1aXJlKCcuLi9taWRkbGV3YXJlJyk7XG5jb25zdCBwa2dKU09OID0gcmVxdWlyZSgnLi4vLi4vLi4vcGFja2FnZS5qc29uJyk7XG5cbmNvbnN0IERFRkFVTFRfTEFOR1VBR0UgPSAnZXMtVVMnO1xuXG5leHBvcnQgZnVuY3Rpb24gbG9hZFRoZW1lKGNvbmZpZykge1xuICBpZiAoXy5pc05pbChjb25maWcudGhlbWUpID09PSBmYWxzZSkge1xuICAgIHJldHVybiBfLmhlYWQoXG4gICAgICBsb2FkUGx1Z2luKFxuICAgICAgICBjb25maWcsXG4gICAgICAgIGNvbmZpZy50aGVtZSxcbiAgICAgICAge30sXG4gICAgICAgIGZ1bmN0aW9uIChwbHVnaW4pIHtcbiAgICAgICAgICByZXR1cm4gXy5pc1N0cmluZyhwbHVnaW4pO1xuICAgICAgICB9LFxuICAgICAgICAndmVyZGFjY2lvLXRoZW1lJ1xuICAgICAgKVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlUHJpbWFyeUNvbG9yKHByaW1hcnlDb2xvcikge1xuICBjb25zdCBpc0hleCA9IC9eIysoW2EtZkEtRjAtOV17Nn18W2EtZkEtRjAtOV17M30pJC9pLnRlc3QocHJpbWFyeUNvbG9yKTtcbiAgaWYgKCFpc0hleCkge1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIHJldHVybiBwcmltYXJ5Q29sb3I7XG59XG5cbmNvbnN0IHNlbmRGaWxlQ2FsbGJhY2sgPSAobmV4dCkgPT4gKGVycikgPT4ge1xuICBpZiAoIWVycikge1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoZXJyLnN0YXR1cyA9PT0gSFRUUF9TVEFUVVMuTk9UX0ZPVU5EKSB7XG4gICAgbmV4dCgpO1xuICB9IGVsc2Uge1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKGNvbmZpZywgYXV0aCwgc3RvcmFnZSkge1xuICBTZWFyY2guY29uZmlndXJlU3RvcmFnZShzdG9yYWdlKTtcbiAgLyogZXNsaW50IG5ldy1jYXA6b2ZmICovXG4gIGNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5cbiAgcm91dGVyLnVzZShhdXRoLndlYlVJSldUbWlkZGxld2FyZSgpKTtcbiAgcm91dGVyLnVzZShzZXRTZWN1cml0eVdlYkhlYWRlcnMpO1xuICBjb25zdCB0aGVtZVBhdGggPSBsb2FkVGhlbWUoY29uZmlnKSB8fCByZXF1aXJlKCdAdmVyZGFjY2lvL3VpLXRoZW1lJykoKTtcbiAgY29uc3QgaW5kZXhUZW1wbGF0ZSA9IHBhdGguam9pbih0aGVtZVBhdGgsICdpbmRleC5odG1sJyk7XG4gIGNvbnN0IHRlbXBsYXRlID0gZnMucmVhZEZpbGVTeW5jKGluZGV4VGVtcGxhdGUpLnRvU3RyaW5nKCk7XG5cbiAgLy8gTG9nb1xuICBsZXQgbG9nb1VSSSA9IF8uZ2V0KGNvbmZpZywgJ3dlYi5sb2dvJykgPyBjb25maWcud2ViLmxvZ28gOiAnJztcbiAgaWYgKGxvZ29VUkkgJiYgIWlzSFRUUFByb3RvY29sKGxvZ29VUkkpKSB7XG4gICAgLy8gVVJJIHJlbGF0ZWQgdG8gYSBsb2NhbCBmaWxlXG5cbiAgICAvLyBOb3RlOiBgcGF0aC5qb2luYCB3aWxsIGJyZWFrIG9uIFdpbmRvd3MsIGJlY2F1c2UgaXQgdHJhbnNmb3JtcyBgL2AgdG8gYFxcYFxuICAgIC8vIFVzZSBQT1NJWCB2ZXJzaW9uIGBwYXRoLnBvc2l4LmpvaW5gIGluc3RlYWQuXG4gICAgbG9nb1VSSSA9IHBhdGgucG9zaXguam9pbignLy0vc3RhdGljLycsIHBhdGguYmFzZW5hbWUobG9nb1VSSSkpO1xuICAgIHJvdXRlci5nZXQobG9nb1VSSSwgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgICByZXMuc2VuZEZpbGUocGF0aC5yZXNvbHZlKGNvbmZpZy53ZWIubG9nbyksIHNlbmRGaWxlQ2FsbGJhY2sobmV4dCkpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gU3RhdGljXG4gIHJvdXRlci5nZXQoJy8tL3N0YXRpYy8qJywgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgY29uc3QgZmlsZW5hbWUgPSByZXEucGFyYW1zWzBdO1xuICAgIGNvbnN0IGZpbGUgPSBgJHt0aGVtZVBhdGh9LyR7ZmlsZW5hbWV9YDtcbiAgICByZXMuc2VuZEZpbGUoZmlsZSwgc2VuZEZpbGVDYWxsYmFjayhuZXh0KSk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIHJlbmRlckhUTUwocmVxLCByZXMpIHtcbiAgICBjb25zdCBwcm90b2NvbCA9IGdldFdlYlByb3RvY29sKHJlcS5nZXQoSEVBREVSUy5GT1JXQVJERURfUFJPVE8pLCByZXEucHJvdG9jb2wpO1xuICAgIGNvbnN0IGhvc3QgPSByZXEuZ2V0KCdob3N0Jyk7XG4gICAgY29uc3QgeyB1cmxfcHJlZml4IH0gPSBjb25maWc7XG4gICAgY29uc3QgdXJpID0gYCR7cHJvdG9jb2x9Oi8vJHtob3N0fWA7XG4gICAgY29uc3QgYmFzZSA9IGNvbWJpbmVCYXNlVXJsKHByb3RvY29sLCBob3N0LCB1cmxfcHJlZml4KTtcbiAgICBjb25zdCBsYW5ndWFnZSA9IGNvbmZpZz8uaTE4bj8ud2ViID8/IERFRkFVTFRfTEFOR1VBR0U7XG4gICAgY29uc3QgZGFya01vZGUgPSBjb25maWc/LndlYj8uZGFya01vZGUgPz8gZmFsc2U7XG4gICAgY29uc3QgcHJpbWFyeUNvbG9yID0gdmFsaWRhdGVQcmltYXJ5Q29sb3IoY29uZmlnPy53ZWI/LnByaW1hcnlfY29sb3IpO1xuICAgIGNvbnN0IHRpdGxlID0gXy5nZXQoY29uZmlnLCAnd2ViLnRpdGxlJykgPyBjb25maWcud2ViLnRpdGxlIDogV0VCX1RJVExFO1xuICAgIGNvbnN0IHNjb3BlID0gXy5nZXQoY29uZmlnLCAnd2ViLnNjb3BlJykgPyBjb25maWcud2ViLnNjb3BlIDogJyc7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIHVyaSxcbiAgICAgIGRhcmtNb2RlLFxuICAgICAgcHJvdG9jb2wsXG4gICAgICBob3N0LFxuICAgICAgdXJsX3ByZWZpeCxcbiAgICAgIGJhc2UsXG4gICAgICBwcmltYXJ5Q29sb3IsXG4gICAgICB0aXRsZSxcbiAgICAgIHNjb3BlLFxuICAgICAgbGFuZ3VhZ2VcbiAgICB9O1xuXG4gICAgY29uc3Qgd2ViUGFnZSA9IHRlbXBsYXRlXG4gICAgICAucmVwbGFjZSgvVG9SZXBsYWNlQnlWZXJkYWNjaW9VSS9nLCBKU09OLnN0cmluZ2lmeShvcHRpb25zKSlcbiAgICAgIC5yZXBsYWNlKC9Ub1JlcGxhY2VCeVZlcmRhY2Npby9nLCBiYXNlKVxuICAgICAgLnJlcGxhY2UoL1RvUmVwbGFjZUJ5UHJlZml4L2csIHVybF9wcmVmaXgpXG4gICAgICAucmVwbGFjZSgvVG9SZXBsYWNlQnlWZXJzaW9uL2csIHBrZ0pTT04udmVyc2lvbilcbiAgICAgIC5yZXBsYWNlKC9Ub1JlcGxhY2VCeVRpdGxlL2csIHRpdGxlKVxuICAgICAgLnJlcGxhY2UoL1RvUmVwbGFjZUJ5TG9nby9nLCBsb2dvVVJJKVxuICAgICAgLnJlcGxhY2UoL1RvUmVwbGFjZUJ5UHJpbWFyeUNvbG9yL2csIHByaW1hcnlDb2xvcilcbiAgICAgIC5yZXBsYWNlKC9Ub1JlcGxhY2VCeVNjb3BlL2csIHNjb3BlKTtcblxuICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIEhFQURFUlMuVEVYVF9IVE1MKTtcblxuICAgIHJlcy5zZW5kKHdlYlBhZ2UpO1xuICB9XG5cbiAgcm91dGVyLmdldCgnLy0vd2ViLzpzZWN0aW9uLyonLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICByZW5kZXJIVE1MKHJlcSwgcmVzKTtcbiAgfSk7XG5cbiAgcm91dGVyLmdldCgnLycsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIHJlbmRlckhUTUwocmVxLCByZXMpO1xuICB9KTtcblxuICByZXR1cm4gcm91dGVyO1xufVxuIl19