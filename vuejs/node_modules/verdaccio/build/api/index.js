"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _express = _interopRequireDefault(require("express"));

var _compression = _interopRequireDefault(require("compression"));

var _cors = _interopRequireDefault(require("cors"));

var _storage = _interopRequireDefault(require("../lib/storage"));

var _pluginLoader = _interopRequireDefault(require("../lib/plugin-loader"));

var _auth = _interopRequireDefault(require("../lib/auth"));

var _utils = require("../lib/utils");

var _constants = require("../lib/constants");

var _config = _interopRequireDefault(require("../lib/config"));

var _logger = require("../lib/logger");

var _api = _interopRequireDefault(require("./web/api"));

var _web = _interopRequireDefault(require("./web"));

var _endpoint = _interopRequireDefault(require("./endpoint"));

var _debug = _interopRequireDefault(require("./debug"));

var _middleware = require("./middleware");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const defineAPI = function (config, storage) {
  const auth = new _auth.default(config);
  const app = (0, _express.default)(); // run in production mode by default, just in case
  // it shouldn't make any difference anyway

  app.set('env', process.env.NODE_ENV || 'production');
  app.use((0, _cors.default)()); // Router setup

  app.use((0, _middleware.log)(config));
  app.use(_middleware.errorReportingMiddleware);
  app.use(function (req, res, next) {
    res.setHeader('X-Powered-By', config.user_agent);
    next();
  });
  app.use((0, _compression.default)());
  app.get('/favicon.ico', function (req, res, next) {
    req.url = '/-/static/favicon.png';
    next();
  }); // Hook for tests only

  if (config._debug) {
    (0, _debug.default)(app, config.self_path);
  } // register middleware plugins


  const plugin_params = {
    config: config,
    logger: _logger.logger
  };
  const plugins = (0, _pluginLoader.default)(config, config.middlewares, plugin_params, function (plugin) {
    return plugin.register_middlewares;
  });
  plugins.forEach(plugin => {
    plugin.register_middlewares(app, auth, storage);
  }); // For  npm request

  app.use((0, _endpoint.default)(config, auth, storage)); // For WebUI & WebUI API

  if (_lodash.default.get(config, 'web.enable', true)) {
    app.use('/', (0, _web.default)(config, auth, storage));
    app.use('/-/verdaccio/', (0, _api.default)(config, auth, storage));
  } else {
    app.get('/', function (req, res, next) {
      next(_utils.ErrorCode.getNotFound(_constants.API_ERROR.WEB_DISABLED));
    });
  } // Catch 404


  app.get('/*', function (req, res, next) {
    next(_utils.ErrorCode.getNotFound(_constants.API_ERROR.FILE_NOT_FOUND));
  });
  app.use(function (err, req, res, next) {
    if (_lodash.default.isError(err)) {
      if (err.code === 'ECONNABORT' && res.statusCode === _constants.HTTP_STATUS.NOT_MODIFIED) {
        return next();
      }

      if (_lodash.default.isFunction(res.report_error) === false) {
        // in case of very early error this middleware may not be loaded before error is generated
        // fixing that
        (0, _middleware.errorReportingMiddleware)(req, res, _lodash.default.noop);
      }

      res.report_error(err);
    } else {
      // Fall to Middleware.final
      return next(err);
    }
  });
  app.use(_middleware.final);
  return app;
};

var _default = async function _default(configHash) {
  (0, _logger.setup)(configHash.logs);
  const config = new _config.default(_lodash.default.cloneDeep(configHash)); // register middleware plugins

  const plugin_params = {
    config: config,
    logger: _logger.logger
  };
  const filters = (0, _pluginLoader.default)(config, config.filters || {}, plugin_params, plugin => plugin.filter_metadata);
  const storage = new _storage.default(config); // waits until init calls have been initialized

  await storage.init(config, filters);
  return defineAPI(config, storage);
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvaW5kZXgudHMiXSwibmFtZXMiOlsiZGVmaW5lQVBJIiwiY29uZmlnIiwic3RvcmFnZSIsImF1dGgiLCJBdXRoIiwiYXBwIiwic2V0IiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwidXNlIiwiZXJyb3JSZXBvcnRpbmdNaWRkbGV3YXJlIiwicmVxIiwicmVzIiwibmV4dCIsInNldEhlYWRlciIsInVzZXJfYWdlbnQiLCJnZXQiLCJ1cmwiLCJfZGVidWciLCJzZWxmX3BhdGgiLCJwbHVnaW5fcGFyYW1zIiwibG9nZ2VyIiwicGx1Z2lucyIsIm1pZGRsZXdhcmVzIiwicGx1Z2luIiwicmVnaXN0ZXJfbWlkZGxld2FyZXMiLCJmb3JFYWNoIiwiXyIsIkVycm9yQ29kZSIsImdldE5vdEZvdW5kIiwiQVBJX0VSUk9SIiwiV0VCX0RJU0FCTEVEIiwiRklMRV9OT1RfRk9VTkQiLCJlcnIiLCJpc0Vycm9yIiwiY29kZSIsInN0YXR1c0NvZGUiLCJIVFRQX1NUQVRVUyIsIk5PVF9NT0RJRklFRCIsImlzRnVuY3Rpb24iLCJyZXBvcnRfZXJyb3IiLCJub29wIiwiZmluYWwiLCJjb25maWdIYXNoIiwibG9ncyIsIkFwcENvbmZpZyIsImNsb25lRGVlcCIsImZpbHRlcnMiLCJmaWx0ZXJfbWV0YWRhdGEiLCJTdG9yYWdlIiwiaW5pdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQVFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsU0FBUyxHQUFHLFVBQVVDLE1BQVYsRUFBMkJDLE9BQTNCLEVBQTBEO0FBQzFFLFFBQU1DLElBQVcsR0FBRyxJQUFJQyxhQUFKLENBQVNILE1BQVQsQ0FBcEI7QUFDQSxRQUFNSSxHQUFnQixHQUFHLHVCQUF6QixDQUYwRSxDQUcxRTtBQUNBOztBQUNBQSxFQUFBQSxHQUFHLENB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QUosQ0FBWWpELE1BQVosQ0FBakMsQ0FkNkQsQ0FlN0Q7O0FBQ0EsUUFBTUMsT0FBTyxDQUFDaUQsSUFBUixDQUFhbEQsTUFBYixFQUFxQitDLE9BQXJCLENBQU47QUFDQSxTQUFPaEQsU0FBUyxDQUFDQyxNQUFELEVBQVNDLE9BQVQsQ0FBaEI7QUFDRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBleHByZXNzLCB7IEFwcGxpY2F0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgY29tcHJlc3Npb24gZnJvbSAnY29tcHJlc3Npb24nO1xuaW1wb3J0IGNvcnMgZnJvbSAnY29ycyc7XG5pbXBvcnQgeyBIdHRwRXJyb3IgfSBmcm9tICdodHRwLWVycm9ycyc7XG5pbXBvcnQgeyBDb25maWcgYXMgSUNvbmZpZywgSVBsdWdpbk1pZGRsZXdhcmUsIElQbHVnaW5TdG9yYWdlRmlsdGVyIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5pbXBvcnQgU3RvcmFnZSBmcm9tICcuLi9saWIvc3RvcmFnZSc7XG5pbXBvcnQgbG9hZFBsdWdpbiBmcm9tICcuLi9saWIvcGx1Z2luLWxvYWRlcic7XG5pbXBvcnQgQXV0aCBmcm9tICcuLi9saWIvYXV0aCc7XG5pbXBvcnQgeyBFcnJvckNvZGUgfSBmcm9tICcuLi9saWIvdXRpbHMnO1xuaW1wb3J0IHsgQVBJX0VSUk9SLCBIVFRQX1NUQVRVUyB9IGZyb20gJy4uL2xpYi9jb25zdGFudHMnO1xuaW1wb3J0IEFwcENvbmZpZyBmcm9tICcuLi9saWIvY29uZmlnJztcbmltcG9ydCB7XG4gICRSZXNwb25zZUV4dGVuZCxcbiAgJFJlcXVlc3RFeHRlbmQsXG4gICROZXh0RnVuY3Rpb25WZXIsXG4gIElTdG9yYWdlSGFuZGxlcixcbiAgSUF1dGhcbn0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgc2V0dXAsIGxvZ2dlciB9IGZyb20gJy4uL2xpYi9sb2dnZXInO1xuaW1wb3J0IHdlYkFQSSBmcm9tICcuL3dlYi9hcGknO1xuaW1wb3J0IHdlYiBmcm9tICcuL3dlYic7XG5pbXBvcnQgYXBpRW5kcG9pbnQgZnJvbSAnLi9lbmRwb2ludCc7XG5pbXBvcnQgaG9va0RlYnVnIGZyb20gJy4vZGVidWcnO1xuaW1wb3J0IHsgbG9nLCBmaW5hbCwgZXJyb3JSZXBvcnRpbmdNaWRkbGV3YXJlIH0gZnJvbSAnLi9taWRkbGV3YXJlJztcblxuY29uc3QgZGVmaW5lQVBJID0gZnVuY3Rpb24gKGNvbmZpZzogSUNvbmZpZywgc3RvcmFnZTogSVN0b3JhZ2VIYW5kbGVyKTogYW55IHtcbiAgY29uc3QgYXV0aDogSUF1dGggPSBuZXcgQXV0aChjb25maWcpO1xuICBjb25zdCBhcHA6IEFwcGxpY2F0aW9uID0gZXhwcmVzcygpO1xuICAvLyBydW4gaW4gcHJvZHVjdGlvbiBtb2RlIGJ5IGRlZmF1bHQsIGp1c3QgaW4gY2FzZVxuICAvLyBpdCBzaG91bGRuJ3QgbWFrZSBhbnkgZGlmZmVyZW5jZSBhbnl3YXlcbiAgYXBwLnNldCgnZW52JywgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgfHwgJ3Byb2R1Y3Rpb24nKTtcbiAgYXBwLnVzZShjb3JzKCkpO1xuXG4gIC8vIFJvdXRlciBzZXR1cFxuICBhcHAudXNlKGxvZyhjb25maWcpKTtcbiAgYXBwLnVzZShlcnJvclJlcG9ydGluZ01pZGRsZXdhcmUpO1xuICBhcHAudXNlKGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcik6IHZvaWQge1xuICAgIHJlcy5zZXRIZWFkZXIoJ1gtUG93ZXJlZC1CeScsIGNvbmZpZy51c2VyX2FnZW50KTtcbiAgICBuZXh0KCk7XG4gIH0pO1xuXG4gIGFwcC51c2UoY29tcHJlc3Npb24oKSk7XG5cbiAgYXBwLmdldChcbiAgICAnL2Zhdmljb24uaWNvJyxcbiAgICBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpOiB2b2lkIHtcbiAgICAgIHJlcS51cmwgPSAnLy0vc3RhdGljL2Zhdmljb24ucG5nJztcbiAgICAgIG5leHQoKTtcbiAgICB9XG4gICk7XG5cbiAgLy8gSG9vayBmb3IgdGVzdHMgb25seVxuICBpZiAoY29uZmlnLl9kZWJ1Zykge1xuICAgIGhvb2tEZWJ1ZyhhcHAsIGNvbmZpZy5zZWxmX3BhdGgpO1xuICB9XG5cbiAgLy8gcmVnaXN0ZXIgbWlkZGxld2FyZSBwbHVnaW5zXG4gIGNvbnN0IHBsdWdpbl9wYXJhbXMgPSB7XG4gICAgY29uZmlnOiBjb25maWcsXG4gICAgbG9nZ2VyOiBsb2dnZXJcbiAgfTtcblxuICBjb25zdCBwbHVnaW5zOiBJUGx1Z2luTWlkZGxld2FyZTxJQ29uZmlnPltdID0gbG9hZFBsdWdpbihcbiAgICBjb25maWcsXG4gICAgY29uZmlnLm1pZGRsZXdhcmVzLFxuICAgIHBsdWdpbl9wYXJhbXMsXG4gICAgZnVuY3Rpb24gKHBsdWdpbjogSVBsdWdpbk1pZGRsZXdhcmU8SUNvbmZpZz4pIHtcbiAgICAgIHJldHVybiBwbHVnaW4ucmVnaXN0ZXJfbWlkZGxld2FyZXM7XG4gICAgfVxuICApO1xuICBwbHVnaW5zLmZvckVhY2goKHBsdWdpbjogSVBsdWdpbk1pZGRsZXdhcmU8SUNvbmZpZz4pID0+IHtcbiAgICBwbHVnaW4ucmVnaXN0ZXJfbWlkZGxld2FyZXMoYXBwLCBhdXRoLCBzdG9yYWdlKTtcbiAgfSk7XG5cbiAgLy8gRm9yICBucG0gcmVxdWVzdFxuICBhcHAudXNlKGFwaUVuZHBvaW50KGNvbmZpZywgYXV0aCwgc3RvcmFnZSkpO1xuXG4gIC8vIEZvciBXZWJVSSAmIFdlYlVJIEFQSVxuICBpZiAoXy5nZXQoY29uZmlnLCAnd2ViLmVuYWJsZScsIHRydWUpKSB7XG4gICAgYXBwLnVzZSgnLycsIHdlYihjb25maWcsIGF1dGgsIHN0b3JhZ2UpKTtcbiAgICBhcHAudXNlKCcvLS92ZXJkYWNjaW8vJywgd2ViQVBJKGNvbmZpZywgYXV0aCwgc3RvcmFnZSkpO1xuICB9IGVsc2Uge1xuICAgIGFwcC5nZXQoJy8nLCBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpIHtcbiAgICAgIG5leHQoRXJyb3JDb2RlLmdldE5vdEZvdW5kKEFQSV9FUlJPUi5XRUJfRElTQUJMRUQpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIENhdGNoIDQwNFxuICBhcHAuZ2V0KCcvKicsIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcikge1xuICAgIG5leHQoRXJyb3JDb2RlLmdldE5vdEZvdW5kKEFQSV9FUlJPUi5GSUxFX05PVF9GT1VORCkpO1xuICB9KTtcblxuICBhcHAudXNlKGZ1bmN0aW9uIChcbiAgICBlcnI6IEh0dHBFcnJvcixcbiAgICByZXE6ICRSZXF1ZXN0RXh0ZW5kLFxuICAgIHJlczogJFJlc3BvbnNlRXh0ZW5kLFxuICAgIG5leHQ6ICROZXh0RnVuY3Rpb25WZXJcbiAgKSB7XG4gICAgaWYgKF8uaXNFcnJvcihlcnIpKSB7XG4gICAgICBpZiAoZXJyLmNvZGUgPT09ICdFQ09OTkFCT1JUJyAmJiByZXMuc3RhdHVzQ29kZSA9PT0gSFRUUF9TVEFUVVMuTk9UX01PRElGSUVEKSB7XG4gICAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgICB9XG4gICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlcy5yZXBvcnRfZXJyb3IpID09PSBmYWxzZSkge1xuICAgICAgICAvLyBpbiBjYXNlIG9mIHZlcnkgZWFybHkgZXJyb3IgdGhpcyBtaWRkbGV3YXJlIG1heSBub3QgYmUgbG9hZGVkIGJlZm9yZSBlcnJvciBpcyBnZW5lcmF0ZWRcbiAgICAgICAgLy8gZml4aW5nIHRoYXRcbiAgICAgICAgZXJyb3JSZXBvcnRpbmdNaWRkbGV3YXJlKHJlcSwgcmVzLCBfLm5vb3ApO1xuICAgICAgfVxuICAgICAgcmVzLnJlcG9ydF9lcnJvcihlcnIpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBGYWxsIHRvIE1pZGRsZXdhcmUuZmluYWxcbiAgICAgIHJldHVybiBuZXh0KGVycik7XG4gICAgfVxuICB9KTtcblxuICBhcHAudXNlKGZpbmFsKTtcblxuICByZXR1cm4gYXBwO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgKGFzeW5jIGZ1bmN0aW9uIChjb25maWdIYXNoOiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICBzZXR1cChjb25maWdIYXNoLmxvZ3MpO1xuICBjb25zdCBjb25maWc6IElDb25maWcgPSBuZXcgQXBwQ29uZmlnKF8uY2xvbmVEZWVwKGNvbmZpZ0hhc2gpKTtcbiAgLy8gcmVnaXN0ZXIgbWlkZGxld2FyZSBwbHVnaW5zXG4gIGNvbnN0IHBsdWdpbl9wYXJhbXMgPSB7XG4gICAgY29uZmlnOiBjb25maWcsXG4gICAgbG9nZ2VyOiBsb2dnZXJcbiAgfTtcbiAgY29uc3QgZmlsdGVycyA9IGxvYWRQbHVnaW4oXG4gICAgY29uZmlnLFxuICAgIGNvbmZpZy5maWx0ZXJzIHx8IHt9LFxuICAgIHBsdWdpbl9wYXJhbXMsXG4gICAgKHBsdWdpbjogSVBsdWdpblN0b3JhZ2VGaWx0ZXI8SUNvbmZpZz4pID0+IHBsdWdpbi5maWx0ZXJfbWV0YWRhdGFcbiAgKTtcbiAgY29uc3Qgc3RvcmFnZTogSVN0b3JhZ2VIYW5kbGVyID0gbmV3IFN0b3JhZ2UoY29uZmlnKTtcbiAgLy8gd2FpdHMgdW50aWwgaW5pdCBjYWxscyBoYXZlIGJlZW4gaW5pdGlhbGl6ZWRcbiAgYXdhaXQgc3RvcmFnZS5pbml0KGNvbmZpZywgZmlsdGVycyk7XG4gIHJldHVybiBkZWZpbmVBUEkoY29uZmlnLCBzdG9yYWdlKTtcbn0pO1xuIl19